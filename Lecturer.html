<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lecturer Dash Edu-Tend System</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/date-fns.min.js"></script>
  </head>
  <body class="admin-dashboard">
    <div class="sidebar nav" id="sidebar">
      <h2>Lecturer Dashboard</h2>
      <nav>
        <a href="#" class="lecturer-nav-item active" data-target="dashboard">
          <i class="mr-3 fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="#" class="lecturer-nav-item" data-target="profile">
          <i class="mr-3 fas fa-user"></i> Profile
        </a>
        <a href="#" class="lecturer-nav-item" data-target="calendar">
          <i class="mr-3 fas fa-calendar"></i> Calendar
        </a>
        <a href="lecturec.html" class="lecturer-nav-item">
          <i class="mr-3 fas fa-book"></i> Course Management
        </a>
        <a href="#" class="lecturer-nav-item" data-target="qrcode">
          <i class="mr-3 fas fa-qrcode"></i> Generate QR Code
        </a>
        <a href="#" class="lecturer-nav-item" data-target="attendance">
          <i class="mr-3 fas fa-check"></i> Attendance Records
        </a>
        <a href="#" class="lecturer-nav-item" data-target="reports">
          <i class="mr-3 fas fa-chart-bar"></i> Reports
        </a>
        <a href="#" class="lecturer-nav-item" data-target="settings">
          <i class="mr-3 fas fa-cog"></i> Settings
        </a>
        <a href="index.html" class="lecturer-nav-item">
          <i class="mr-3 fas fa-sign-out-alt"></i> Logout
        </a>
      </nav>
    </div>

    <div class="main-content">
      <header class="header">
        <!-- Enhanced Mobile Sidebar Toggle -->
        <div class="toggle">
          <button id="sidebar-toggle" class="toggle-btn" aria-label="Open Menu">
            <i class="fas fa-bars"></i>
          </button>
        </div>
        
        <!-- Enhanced Mobile Sidebar -->
        <div class="sidebar2" id="sidebar2">
          <div class="sidebar-header">
            <div class="sidebar-title">
              <h2 class="h1">Lecturer Dashboard</h2>
              <p class="h2">EdUTEND System</p>
            </div>
            <button id="sidebar-close" class="sidebar-close-btn" aria-label="Close Menu">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <nav class="mobile-nav">
            <a href="#" class="lecturer-nav-item active" data-target="dashboard">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
            <a href="#" class="lecturer-nav-item" data-target="profile">
              <i class="fas fa-user"></i>
              <span>Profile</span>
            </a>
            <a href="#" class="lecturer-nav-item" data-target="calendar">
              <i class="fas fa-calendar"></i>
              <span>Calendar</span>
            </a>
            <a href="lecturec.html" class="lecturer-nav-item">
              <i class="fas fa-book"></i>
              <span>Course Management</span>
            </a>
            <a href="#" class="lecturer-nav-item" data-target="qrcode">
              <i class="fas fa-qrcode"></i>
              <span>Generate QR Code</span>
            </a>
            <a href="#" class="lecturer-nav-item" data-target="attendance">
              <i class="fas fa-check"></i>
              <span>Attendance Records</span>
            </a>
            <a href="#" class="lecturer-nav-item" data-target="reports">
              <i class="fas fa-chart-bar"></i>
              <span>Reports</span>
            </a>
            <a href="#" class="lecturer-nav-item" data-target="settings">
              <i class="fas fa-cog"></i>
              <span>Settings</span>
            </a>
            <a href="index.html" class="lecturer-nav-item logout-item">
              <i class="fas fa-sign-out-alt"></i>
              <span>Logout</span>
            </a>
          </nav>
          
          <!-- Mobile User Info -->
          <div class="mobile-user-info">
            <div class="user-avatar">LC</div>
            <div class="user-details">
              <p class="user-name">Lecturer</p>
              <p class="user-role">Course Instructor</p>
            </div>
          </div>
        </div>
        
        <!-- Header Content -->
        <div class="user-info">
          <span>Welcome, Lecturer</span>
        </div>
        <div class="header-actions"></div>
      </header>

      <div id="dashboard" class="section">
        <h3>Dashboard Overview</h3>
        <p>Welcome to our dashboard</p>
      </div>

      <div id="profile" class="section">
        <h3>Profile</h3>
        <div class="profile-card">
          <div class="profile-header">
            <div class="avatar" id="profile-avatar">LC</div>
            <div class="identity">
              <h4 id="profile-name">Lecturer Name</h4>
              <p id="profile-email" class="muted">email@example.com</p>
            </div>
          </div>
          <div class="profile-details">
            <div class="detail"><span>Department</span><strong id="profile-department">â€”</strong></div>
            <div class="detail"><span>Office</span><strong id="profile-office">â€”</strong></div>
            <div class="detail"><span>Phone</span><strong id="profile-phone">â€”</strong></div>
          </div>
          <div class="profile-bio">
            <h5>Biography</h5>
            <p id="profile-bio">Add a short biography in Settings.</p>
          </div>
          <div class="profile-actions">
            <a href="#" class="btn go-settings" data-target="settings">Edit Profile</a>
          </div>
        </div>
      </div>

      <div id="qrcode" class="section">
        <h3>Generate Session QR Code</h3>
        
        <!-- Course Selection -->
        <div class="course-selection">
          <label for="course-select">Select Course:</label>
          <select id="course-select" class="form-field">
            <option value="">Choose a course...</option>
            <option value="HCI">Human Computer Interaction II (HCI)</option>
            <option value="TEP">Technical Programming I (TEP)</option>
            <option value="DES">Development Software II (DES)</option>
            <option value="INF">Information System II (INF)</option>
            <option value="DEV">Development Software I (DEV)</option>
            <option value="ITS">Information Technology Skills I (ITS)</option>
            <option value="IS">Information Systems I (IS)</option>
            <option value="SS">System Software I (SS)</option>
          </select>
        </div>
        
        <button class="btn" id="generate-qr-btn">Generate PIN &amp; QR Code</button>
        
        <!-- Session Status Indicator -->
        <div id="session-status-indicator" class="session-status-indicator" style="display: none;">
          <span class="status-dot active"></span>
          <span class="status-text">Session Active</span>
        </div>
        
        <!-- Close Session Button - More Prominent -->
        <button class="btn btn-danger" id="prominent-close-session-btn" onclick="closeCurrentSession()" style="display: none; margin-top: 10px; width: 100%;">
          <strong>ðŸ”’ Close Active Session</strong>
        </button>
        
        <div class="timer-controls">
          <span>Set timer:</span>
          <button class="btn" onclick="setTimer(5)">5 min</button>
          <button class="btn" onclick="setTimer(10)">10 min</button>
          <button class="btn" onclick="setTimer(15)">15 min</button>
          <button class="btn btn-danger" id="close-session-btn" onclick="closeCurrentSession()" style="display: none;">Close Session</button>
        </div>
        <div id="qr-display-area" class="qr-display-area">
          <div id="qrcode-container">
            <div id="qrcodeCanvas"></div>
          </div>
          <p id="pin-display"></p>
          <p id="timer-display" class="timer-display"></p>
          
          <!-- Course Session Info -->
          <div class="course-session-info" id="course-session-info" style="display: none;">
            <h4>Session Information</h4>
            <p><strong>Course:</strong> <span id="qr-course-name">-</span></p>
            <p><strong>Code:</strong> <span id="qr-course-code">-</span></p>
            <p><strong>Session ID:</strong> <span id="qr-session-id">-</span></p>
          </div>
        </div>
        
        <!-- Recent Course Sessions -->
        <div class="recent-sessions">
          <h4>Recent Course Sessions</h4>
          <div id="recent-sessions-list" class="sessions-list">
            <p class="muted">No recent sessions found.</p>
          </div>
        </div>
      </div>

      <div id="attendance" class="section">
        <h3>Attendance</h3>
        <div class="attendance-toolbar">
          <div class="form-grid">
            <div class="form-field">
              <label for="attendance-date-filter">Date</label>
              <input type="date" id="attendance-date-filter" />
            </div>
            <div class="form-field">
              <label for="attendance-course-filter">Course</label>
              <select id="attendance-course-filter">
                <option value="all">All Courses</option>
                <option value="HCI">Human Computer Interaction II</option>
                <option value="INF">Information Systems II</option>
                <option value="DEV">Development Software I</option>
                <option value="ITS">Information Technology Skills I</option>
                <option value="IS">Information Systems I</option>
              </select>
            </div>
            <div class="form-field">
              <label>&nbsp;</label>
              <button class="btn" id="attendance-refresh-btn" type="button">Refresh</button>
            </div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="attendance-table">
            <thead>
              <tr>
                <th>Session</th>
                <th>Course</th>
                <th>Date</th>
                <th>Time</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="attendance-tbody">
              <tr><td colspan="6" class="centered-cell">No sessions yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="reports" class="section">
        <h3>Reports</h3>
        <div class="attendance-toolbar">
          <div class="form-grid">
            <div class="form-field">
              <label for="report-date-from">From</label>
              <input type="date" id="report-date-from" />
            </div>
            <div class="form-field">
              <label for="report-date-to">To</label>
              <input type="date" id="report-date-to" />
            </div>
            <div class="form-field">
              <label for="report-course">Course</label>
              <select id="report-course">
                <option value="all">All Courses</option>
              </select>
            </div>
            <div class="form-field">
              <label>&nbsp;</label>
              <button class="btn" id="report-generate" type="button">Generate</button>
            </div>
          </div>
        </div>
        <div id="report-preview" class="report-preview">
          <div class="report-card" id="report-card">
            <h4>Attendance Report</h4>
            <p class="muted">Use filters above and click Generate to see report preview.</p>
            <div id="report-summary"></div>
            <div class="table-responsive">
              <table class="attendance-table" id="report-table">
                <thead>
                  <tr>
                    <th>Session</th>
                    <th>Course</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="report-actions">
          <button class="btn" id="download-pdf">Download PDF</button>
          <button class="btn" id="download-docx">Download Word</button>
        </div>
      </div>

      <div id="calendar" class="section">
        <h3>Calendar</h3>
        <div class="calendar" id="lecturer-calendar">
          <div class="header">
            <div class="month" id="calendar-month">Month YYYY</div>
            <div class="btns">
              <div class="btn" id="calendar-prev">&#10094;</div>
              <div class="btn" id="calendar-next">&#10095;</div>
            </div>
          </div>
          <div class="weekdays" id="calendar-weekdays"></div>
          <div class="days" id="calendar-days"></div>
        </div>

        <div class="settings-group mt-16">
          <h4>Events for <span id="selected-date-label">Select a date</span></h4>
          
          <!-- Event Form -->
          <form id="event-form" class="event-form">
            <div class="form-grid">
              <div class="form-field">
                <label for="event-title">Event Title</label>
                <input type="text" id="event-title" placeholder="e.g., Lecture: HCI-201" required />
              </div>
              <div class="form-field">
                <label for="event-time">Time</label>
                <input type="time" id="event-time" />
              </div>
              <div class="form-field">
                <label for="event-duration">Duration (minutes)</label>
                <input type="number" id="event-duration" min="15" max="480" value="60" />
              </div>
              <div class="form-field">
                <label for="event-type">Event Type</label>
                <select id="event-type">
                  <option value="lecture">Lecture</option>
                  <option value="tutorial">Tutorial</option>
                  <option value="lab">Lab Session</option>
                  <option value="meeting">Meeting</option>
                  <option value="exam">Exam</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-field">
                <label for="event-location">Location</label>
                <input type="text" id="event-location" placeholder="e.g., Room 101, Block A" />
              </div>
              <div class="form-field">
                <label for="event-description">Description</label>
                <textarea id="event-description" rows="2" placeholder="Event description..."></textarea>
              </div>
              <div class="form-field">
                <label for="event-recurring">Recurring Event</label>
                <select id="event-recurring">
                  <option value="none">No Recurrence</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="biweekly">Bi-weekly</option>
                  <option value="monthly">Monthly</option>
                </select>
              </div>
              <div class="form-field" id="recurring-end-container" style="display: none;">
                <label for="event-recurring-end">End Date</label>
                <input type="date" id="event-recurring-end" />
              </div>
              <div class="form-field full-width">
                <label>&nbsp;</label>
                <button type="submit" class="btn" id="add-event-btn">Add Event</button>
                <button type="button" class="btn btn-secondary" id="clear-event-btn">Clear Form</button>
              </div>
            </div>
          </form>
          
          <!-- Events List -->
          <div class="events-container">
            <div class="events-header">
              <h5>Events for <span id="selected-date-display">Select a date</span></h5>
              <button class="btn btn-small" id="export-events-btn" style="display: none;">Export Events</button>
            </div>
            <ul id="events-list" class="events-list"></ul>
          </div>
        </div>
      </div>

      <div id="settings" class="section">
        <h3>Lecturer Settings</h3>

        <form id="lecturer-settings-form">
          <div class="settings-group">
            <h4>Profile</h4>
            <div class="form-grid">
              <div class="form-field">
                <label for="lecturer-name">Full Name</label>
                <input type="text" id="lecturer-name" placeholder="Enter your full name" />
              </div>
              <div class="form-field">
                <label for="lecturer-email">Email</label>
                <input type="email" id="lecturer-email" placeholder="name@example.com" />
              </div>
              <div class="form-field">
                <label for="lecturer-department">Department</label>
                <input type="text" id="lecturer-department" placeholder="e.g., Computer Science" />
              </div>
              <div class="form-field">
                <label for="lecturer-office">Office Location</label>
                <input type="text" id="lecturer-office" placeholder="e.g., Block B, Room 214" />
              </div>
              <div class="form-field">
                <label for="lecturer-phone">Phone</label>
                <input type="tel" id="lecturer-phone" placeholder="e.g., +27 82 123 4567" />
              </div>
              <div class="form-field full-width">
                <label for="lecturer-bio">Biography</label>
                <textarea id="lecturer-bio" rows="3" placeholder="Short bio..." ></textarea>
              </div>
            </div>
          </div>

          <div class="settings-group">
            <h4>Preferences</h4>
            <div class="form-grid">
              <div class="form-field">
                <label for="default-qr-minutes">Default QR Timer</label>
                <select id="default-qr-minutes">
                  <option value="0">None</option>
                  <option value="5">5 minutes</option>
                  <option value="10">10 minutes</option>
                  <option value="15">15 minutes</option>
                </select>
              </div>
              <div class="form-field">
                <label>Notifications</label>
                <div class="checkboxes">
                  <label><input type="checkbox" id="notif-email" /> Email updates</label>
                  <label><input type="checkbox" id="notif-sms" /> SMS alerts</label>
                </div>
              </div>
              <div class="form-field">
                <label for="theme-select">Theme</label>
                <select id="theme-select">
                  <option value="system">System default</option>
                  <option value="light">Light</option>
                  <option value="dark">Dark</option>
                </select>
              </div>
            </div>
          </div>

          <div class="settings-group">
            <h4>Security</h4>
            <div class="form-grid">
              <div class="form-field">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
              </div>
              <div class="form-field">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
              </div>
              <div class="form-field">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password" />
              </div>
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn" id="save-settings-btn">Save Settings</button>
          </div>
        </form>
      </div>
    </div>

    

    <!-- modular JavaScript files -->
    <script src="js/modules/auth.js"></script>
    <script src="js/modules/qr-manager.js"></script>
    <script src="js/app.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Initialize dashboard sections
        const sections = document.querySelectorAll('.section');
        sections.forEach((sec) => {
          sec.style.display = sec.id === 'dashboard' ? 'block' : 'none';
        });

        // Navigation click handlers
        document.querySelectorAll('.lecturer-nav-item[data-target]').forEach(navItem => {
          navItem.addEventListener('click', (e) => {
            e.preventDefault();
            const target = navItem.getAttribute('data-target');
            
            // Hide all sections
            sections.forEach((sec) => {
              sec.style.display = 'none';
            });
            
            // Show target section
            const targetSection = document.getElementById(target);
            if (targetSection) {
              targetSection.style.display = 'block';
            }
            
            // Update active state
            document.querySelectorAll('.lecturer-nav-item').forEach(item => {
              item.classList.remove('active');
            });
            navItem.classList.add('active');
            
          });
        });

        // QR generation logic
        let currentPin = null;
        let pinExpirationTimer = null;
        let qrCodeInstance = null;
        let sessionsStore = [];
        let selectedCourse = null;

        const generateQrBtn = document.getElementById('generate-qr-btn');
        const qrDisplayArea = document.getElementById('qr-display-area');
        const qrcodeContainer = document.getElementById('qrcodeCanvas');
        const pinDisplay = document.getElementById('pin-display');
        const timerDisplay = document.getElementById('timer-display');
        const courseSelect = document.getElementById('course-select');
        const courseSessionInfo = document.getElementById('course-session-info');
        const recentSessionsList = document.getElementById('recent-sessions-list');

        // Settings elements
        const settingsForm = document.getElementById('lecturer-settings-form');
        const nameInput = document.getElementById('lecturer-name');
        const emailInput = document.getElementById('lecturer-email');
        const departmentInput = document.getElementById('lecturer-department');
        const officeInput = document.getElementById('lecturer-office');
        const phoneInput = document.getElementById('lecturer-phone');
        const bioInput = document.getElementById('lecturer-bio');
        const defaultQrMinutesSelect = document.getElementById('default-qr-minutes');
        const notifEmailCheckbox = document.getElementById('notif-email');
        const notifSmsCheckbox = document.getElementById('notif-sms');
        const themeSelect = document.getElementById('theme-select');
        let defaultQrMinutesPref = 0;
        let themeSetting = 'system';

        function loadLecturerSettings() {
          try {
            const raw = localStorage.getItem('lecturerSettings');
            if (!raw) return;
            
            const data = JSON.parse(raw);
            if (!data || typeof data !== 'object') {
              console.warn('Invalid lecturer settings data format');
              return;
            }
            
            // Safely set input values with validation
            if (nameInput && typeof data.name === 'string') nameInput.value = data.name || '';
            if (emailInput && typeof data.email === 'string') emailInput.value = data.email || '';
            if (departmentInput && typeof data.department === 'string') departmentInput.value = data.department || '';
            if (officeInput && typeof data.office === 'string') officeInput.value = data.office || '';
            if (phoneInput && typeof data.phone === 'string') phoneInput.value = data.phone || '';
            if (bioInput && typeof data.bio === 'string') bioInput.value = data.bio || '';
            
            if (typeof data.defaultQrMinutes === 'number' && data.defaultQrMinutes >= 0) {
              defaultQrMinutesPref = data.defaultQrMinutes;
              if (defaultQrMinutesSelect) defaultQrMinutesSelect.value = String(defaultQrMinutesPref);
            }
            
            if (notifEmailCheckbox && typeof data.notifEmail === 'boolean') {
              notifEmailCheckbox.checked = data.notifEmail;
            }
            
            if (notifSmsCheckbox && typeof data.notifSms === 'boolean') {
              notifSmsCheckbox.checked = data.notifSms;
            }
            
            if (themeSelect && data.theme && ['system', 'light', 'dark'].includes(data.theme)) {
              themeSetting = data.theme;
              themeSelect.value = data.theme;
            }
            
          } catch (e) {
            console.error('Failed to load lecturer settings:', e);
            // Clear corrupted data
            try {
              localStorage.removeItem('lecturerSettings');
            } catch (clearError) {
              console.error('Failed to clear corrupted settings:', clearError);
            }
          }
        }

        function saveLecturerSettings(event) {
          event?.preventDefault?.();
          const payload = {
            name: nameInput?.value?.trim() || '',
            email: emailInput?.value?.trim() || '',
            department: departmentInput?.value?.trim() || '',
            office: officeInput?.value?.trim() || '',
            phone: phoneInput?.value?.trim() || '',
            bio: bioInput?.value?.trim() || '',
            defaultQrMinutes: Number(defaultQrMinutesSelect?.value || 0),
            notifEmail: !!notifEmailCheckbox?.checked,
            notifSms: !!notifSmsCheckbox?.checked,
            theme: themeSelect?.value || 'system',
          };
          localStorage.setItem('lecturerSettings', JSON.stringify(payload));
          defaultQrMinutesPref = payload.defaultQrMinutes;
          alert('Settings saved');
        }

        settingsForm?.addEventListener('submit', saveLecturerSettings);
        loadLecturerSettings();

        // Populate profile from settings
        function updateProfileView(){
          try {
            const raw = localStorage.getItem('lecturerSettings');
            const data = raw ? JSON.parse(raw) : {};
            const name = data.name || 'Lecturer';
            const email = data.email || 'email@example.com';
            const department = data.department || 'â€”';
            const office = data.office || 'â€”';
            const phone = data.phone || 'â€”';
            const bio = data.bio || 'Add a short biography in Settings.';

            const initials = name
              .split(/\s+/)
              .filter(Boolean)
              .slice(0,2)
              .map(s => s[0].toUpperCase())
              .join('') || 'LC';

            const setText = (id, value) => { const el = document.getElementById(id); if (el) el.textContent = value; };
            setText('profile-name', name);
            setText('profile-email', email);
            setText('profile-department', department);
            setText('profile-office', office);
            setText('profile-phone', phone);
            setText('profile-bio', bio);
            const avatar = document.getElementById('profile-avatar');
            if (avatar) avatar.textContent = initials;
          } catch {}
        }
        updateProfileView();

        // When settings saved, refresh profile
        settingsForm?.addEventListener('submit', () => {
          setTimeout(updateProfileView, 0);
        });

        // Allow "Edit Profile" button to open Settings
        document.querySelectorAll('.go-settings').forEach(el => {
          el.addEventListener('click', (e) => {
            e.preventDefault();
            sections.forEach((sec) => { sec.style.display = sec.id === 'settings' ? 'block' : 'none'; });
            document.querySelectorAll('.lecturer-nav-item').forEach(a => a.classList.remove('active'));
            document.querySelector('.lecturer-nav-item[data-target="settings"]').classList.add('active');
          });
        });

        // THEME HANDLING
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
        function getEffectiveTheme() {
          const value = themeSelect?.value || themeSetting || 'system';
          if (value === 'system') {
            return prefersDark && prefersDark.matches ? 'dark' : 'light';
          }
          return value;
        }

        function applyTheme() {
          const effective = getEffectiveTheme();
          document.body.classList.toggle('theme-dark', effective === 'dark');
          document.body.classList.toggle('theme-light', effective === 'light');
          document.body.setAttribute('data-theme', effective);
        }

        // Apply on load
        applyTheme();

        // Update on user change (apply immediately and persist theme only)
        themeSelect?.addEventListener('change', () => {
          // persist only the theme into existing settings, without altering other fields
          try {
            const raw = localStorage.getItem('lecturerSettings');
            const current = raw ? JSON.parse(raw) : {};
            current.theme = themeSelect.value;
            localStorage.setItem('lecturerSettings', JSON.stringify(current));
          } catch {}
          applyTheme();
        });

        // React to system theme changes when on 'system'
        prefersDark && prefersDark.addEventListener('change', () => {
          if ((themeSelect?.value || themeSetting) === 'system') applyTheme();
        });

        function clearExistingTimer() {
          if (pinExpirationTimer) {
            clearInterval(pinExpirationTimer);
            pinExpirationTimer = null;
          }
        }

        function markQrExpired() {
          clearExistingTimer();
          timerDisplay.textContent = 'Expired!';
          currentPin = null;
          pinDisplay.textContent = 'PIN EXPIRED';
          qrDisplayArea.classList.add('expired');
          if (qrCodeInstance) {
            // Clear the QR image so the old PIN cannot be scanned
            qrCodeInstance.clear();
          }
          
          // Mark the current session as closed in courseSessions
          if (selectedCourse) {
            try {
              const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
              const activeSession = courseSessions.find(s => s.status === 'active' && s.courseCode === selectedCourse);
              if (activeSession) {
                activeSession.status = 'closed';
                localStorage.setItem('courseSessions', JSON.stringify(courseSessions));
                displayRecentSessions(); // Refresh the display
              }
            } catch (e) {
              console.warn('Failed to update course session status:', e);
            }
          }
          
          // Hide the session status indicator and close session buttons
          document.getElementById('session-status-indicator').style.display = 'none';
          document.getElementById('close-session-btn').style.display = 'none';
          document.getElementById('prominent-close-session-btn').style.display = 'none';
        }

        function generateNewSession() {
          // Check if a course is selected
          if (!selectedCourse) {
            alert('Please select a course first.');
            return;
          }
          
          // reset any previous state
          clearExistingTimer();
          qrDisplayArea.classList.remove('expired');
          timerDisplay.textContent = '';

          currentPin = Math.floor(100000 + Math.random() * 900000).toString();
          pinDisplay.textContent = `PIN: ${currentPin}`;

          // Create comprehensive session data for QR code
          const now = new Date();
          const sessionId = `S${selectedCourse}${now.getTime()}`;
          const sessionData = {
            pin: currentPin,
            courseCode: selectedCourse,
            courseName: getCourseName(selectedCourse),
            sessionId: sessionId,
            lecturerId: 'L001', // This would come from logged-in lecturer
            lecturerName: 'Dr. Lecturer', // This would come from logged-in lecturer
            createdTime: now.toISOString(),
            expiryTime: null, // Will be set when timer is activated
            status: 'active',
            type: 'attendance',
            maxDuration: defaultQrMinutesPref || 15, // Default 15 minutes
            description: `Attendance session for ${getCourseName(selectedCourse)}`
          };

          if (qrCodeInstance) {
            qrCodeInstance.clear();
            qrCodeInstance.makeCode(JSON.stringify(sessionData));
          } else {
            qrCodeInstance = new QRCode(qrcodeContainer, {
              text: JSON.stringify(sessionData),
              width: 200,
              height: 200,
              colorDark: '#000000',
              colorLight: '#ffffff',
              correctLevel: QRCode.CorrectLevel.H,
            });
          }

          qrDisplayArea.style.display = 'block';
          courseSessionInfo.style.display = 'block';




        
          
        // Show the session status indicator and close session buttons
          document.getElementById('session-status-indicator').style.display = 'flex';
          document.getElementById('close-session-btn').style.display = 'inline-block';
          document.getElementById('prominent-close-session-btn').style.display = 'block';
          
          // Update course session info
          document.getElementById('qr-course-name').textContent = getCourseName(selectedCourse);
          document.getElementById('qr-course-code').textContent = selectedCourse;
          document.getElementById('qr-session-id').textContent = sessionId;
          
          if (defaultQrMinutesPref && defaultQrMinutesPref > 0) {
            window.setTimer(defaultQrMinutesPref);
          }
          
          // Create a new session record in local store
          const session = {
            id: sessionId,
            course: selectedCourse,
            courseName: getCourseName(selectedCourse),
            date: now.toISOString().slice(0,10),
            time: now.toTimeString().slice(0,5),
            status: 'Open',
            pin: currentPin,
            lecturerId: 'L001',
            lecturerName: 'Dr. Lecturer'
          };
          sessionsStore.unshift(session);
          persistSessions();
          
          // Enhanced course session storage for better student integration
          try {
            const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
            
            // Close any existing active sessions for this course
            courseSessions.forEach(s => {
              if (s.courseCode === selectedCourse && s.status === 'active') {
                s.status = 'closed';
                s.closedTime = new Date().toISOString();
              }
            });
            
            const courseSession = {
              sessionId: sessionId,
              courseName: getCourseName(selectedCourse),
              courseCode: selectedCourse,
              pin: currentPin,
              createdTime: now.toISOString(),
              expiryTime: null, // Will be set when timer starts
              status: 'active',
              lecturerId: 'L001',
              lecturerName: 'Dr. Lecturer',
              sessionData: sessionData,
              attendanceCount: 0,
              maxStudents: 100, // Could be configurable
              location: 'Main Campus', // Could be configurable
              notes: ''
            };
            
            courseSessions.unshift(courseSession);
            localStorage.setItem('courseSessions', JSON.stringify(courseSessions));
            
            // Broadcast session update to other tabs/windows
            this.broadcastSessionUpdate(courseSession);
            
          } catch (e) {
            console.warn('Failed to save course session:', e);
          }
          
          // Update recent sessions display
          displayRecentSessions();
          
          // Notify students (if using a real-time system)
          this.notifyStudentsOfNewSession(selectedCourse, sessionId);
        }
        
        // Enhanced session management functions
        function broadcastSessionUpdate(session) {
          // Broadcast to other tabs/windows using localStorage events
          const event = new StorageEvent('storage', {
            key: 'courseSessions',
            newValue: localStorage.getItem('courseSessions'),
            url: window.location.href
          });
          window.dispatchEvent(event);
        }
        
        function notifyStudentsOfNewSession(courseCode, sessionId) {
          // This could be enhanced with WebSockets or Server-Sent Events
          // For now, we'll use localStorage events
          const notification = {
            type: 'newSession',
            courseCode: courseCode,
            sessionId: sessionId,
            timestamp: new Date().toISOString()
          };
          
          localStorage.setItem('sessionNotification', JSON.stringify(notification));
          
          // Clear notification after a short delay
          setTimeout(() => {
            localStorage.removeItem('sessionNotification');
          }, 5000);
        }
        
        // Helper function to get course name from code
        function getCourseName(code) {
          const courseNames = {
            'HCI': 'Human Computer Interaction II',
            'TEP': 'Technical Programming I',
            'DES': 'Development Software II',
            'INF': 'Information System II',
            'DEV': 'Development Software I',
            'ITS': 'Information Technology Skills I',
            'IS': 'Information Systems I',
            'SS': 'System Software I'
          };
          return courseNames[code] || code;
        }
        
        // Display recent course sessions
        function displayRecentSessions() {
          try {
            const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
            const recentSessions = courseSessions.slice(0, 5); // Show last 5 sessions
            
            if (recentSessions.length === 0) {
              recentSessionsList.innerHTML = '<p class="muted">No recent sessions found.</p>';
              return;
            }
            
            let html = '';
            recentSessions.forEach(session => {
              const created = new Date(session.createdTime).toLocaleString();
              const statusClass = session.status === 'active' ? 'status-active' : 'status-closed';
              html += `
                <div class="session-item ${statusClass}">
                  <div class="session-header">
                    <strong>${session.courseName} (${session.courseCode})</strong>
                    <span class="session-status">${session.status}</span>
                  </div>
                  <div class="session-details">
                    <span>Session: ${session.sessionId}</span>
                    <span>Created: ${created}</span>
                  </div>
                </div>
              `;
            });
            recentSessionsList.innerHTML = html;
          } catch (e) {
            console.warn('Failed to display recent sessions:', e);
            recentSessionsList.innerHTML = '<p class="muted">Error loading sessions.</p>';
          }
        }

        window.setTimer = (minutes) => {
          if (!currentPin) {
            alert('Generate a PIN first.');
            return;
          }
          if (pinExpirationTimer) clearInterval(pinExpirationTimer);
          qrDisplayArea.classList.remove('expired');
          let seconds = minutes * 60;
          
          // Update session data with expiration time
          if (selectedCourse) {
            try {
              const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
              const activeSession = courseSessions.find(s => s.status === 'active' && s.courseCode === selectedCourse);
              if (activeSession) {
                const expiresAt = new Date(Date.now() + (minutes * 60 * 1000));
                activeSession.expiryTime = expiresAt.toISOString();
                activeSession.sessionData.expiryTime = expiresAt.toISOString();
                localStorage.setItem('courseSessions', JSON.stringify(courseSessions));
              }
            } catch (e) {
              console.warn('Failed to update session expiration:', e);
            }
          }
          
          pinExpirationTimer = setInterval(() => {
            seconds--;
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            timerDisplay.textContent = `Expires in: ${min}:${sec < 10 ? '0' : ''}${sec}`;
            if (seconds <= 0) {
              markQrExpired();
              // mark last open session as Closed
              const open = sessionsStore.find(s => s.status === 'Open');
              if (open) { open.status = 'Closed'; persistSessions(); }
              if (document.getElementById('attendance')?.style.display === 'block') renderAttendance();
              
              // Also mark course session as closed
              if (selectedCourse) {
                try {
                  const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                  const activeSession = courseSessions.find(s => s.status === 'active' && s.courseCode === selectedCourse);
                  if (activeSession) {
                    activeSession.status = 'closed';
                    activeSession.expiryTime = new Date().toISOString();
                    if (activeSession.sessionData) {
                      activeSession.sessionData.expiryTime = new Date().toISOString();
                    }
                    localStorage.setItem('courseSessions', JSON.stringify(courseSessions));
                    displayRecentSessions();
                  }
                } catch (e) {
                  console.warn('Failed to update course session status:', e);
                }
              }
            }
          }, 1000);
        };

        // Attendance storage and rendering
        function loadSessions(){
          try { sessionsStore = JSON.parse(localStorage.getItem('lecturerSessions')||'[]'); }
          catch { sessionsStore = []; }
        }
        function persistSessions(){
          localStorage.setItem('lecturerSessions', JSON.stringify(sessionsStore));
        }
        loadSessions();

        const attendanceTbody = document.getElementById('attendance-tbody');
        const attendanceRefreshBtn = document.getElementById('attendance-refresh-btn');
        const attendanceDateFilter = document.getElementById('attendance-date-filter');
        const attendanceCourseFilter = document.getElementById('attendance-course-filter');

        function ensureCourseOptions(){
          const existing = new Set(['all']);
          Array.from(attendanceCourseFilter.options).forEach(o => existing.add(o.value));
          sessionsStore.forEach(s => {
            if (!existing.has(s.course)) {
              const opt = document.createElement('option');
              opt.value = s.course; opt.textContent = s.course;
              attendanceCourseFilter.appendChild(opt);
            }
          });
        }

        function renderAttendance(){
          loadSessions();
          ensureCourseOptions();
          const dateFilter = attendanceDateFilter?.value || '';
          const courseFilter = attendanceCourseFilter?.value || 'all';
          const filtered = sessionsStore.filter(s =>
            (!dateFilter || s.date === dateFilter) &&
            (courseFilter === 'all' || s.course === courseFilter)
          );
          attendanceTbody.innerHTML = '';
          if (!filtered.length){
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 6; td.style.textAlign='center';
            td.textContent = 'No sessions found.'; tr.appendChild(td);
            attendanceTbody.appendChild(tr);
            return;
          }
          for (const s of filtered){
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${s.id}</td>
              <td>${s.course}</td>
              <td>${s.date}</td>
              <td>${s.time}</td>
              <td><span class="status-badge ${s.status==='Open'?'open':'closed'}">${s.status}</span></td>
              <td><button class="btn btn-small view-details" data-id="${s.id}">View Details</button></td>
            `;
            attendanceTbody.appendChild(tr);
          }
          // bind view buttons
          attendanceTbody.querySelectorAll('.view-details').forEach(btn => {
            btn.addEventListener('click', () => openAttendanceOverlay(btn.getAttribute('data-id')));
          });
        }

        attendanceRefreshBtn?.addEventListener('click', renderAttendance);
        attendanceDateFilter?.addEventListener('change', renderAttendance);
        attendanceCourseFilter?.addEventListener('change', renderAttendance);

        // Overlay for attendance details
        function openAttendanceOverlay(sessionId){
          const s = sessionsStore.find(x => x.id === sessionId);
          if (!s) return;
          let overlay = document.getElementById('attendance-overlay');
          if (!overlay){
            overlay = document.createElement('div');
            overlay.id = 'attendance-overlay';
            overlay.className = 'overlay-backdrop';
            overlay.innerHTML = `
              <div class="overlay-card">
                <div class="overlay-header">
                  <h4>Session Details</h4>
                  <button class="overlay-close" aria-label="Close">Ã—</button>
                </div>
                <div class="overlay-content">
                  <div class="details-grid">
                    <div><span>Session:</span><strong id="ov-session"></strong></div>
                    <div><span>Course:</span><strong id="ov-course"></strong></div>
                    <div><span>Date:</span><strong id="ov-date"></strong></div>
                    <div><span>Time:</span><strong id="ov-time"></strong></div>
                    <div><span>Status:</span><strong id="ov-status"></strong></div>
                  </div>
                  <div class="mt-12">
                    <h5>Attendees</h5>
                    <ul id="ov-attendees" class="attendees-list"><li>No attendees recorded.</li></ul>
                  </div>
                </div>
                <div class="overlay-actions">
                  <button class="btn" id="overlay-close-btn">Close</button>
                </div>
              </div>`;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeAttendanceOverlay(); });
            overlay.querySelector('.overlay-close').addEventListener('click', closeAttendanceOverlay);
            overlay.querySelector('#overlay-close-btn').addEventListener('click', closeAttendanceOverlay);
          }
          overlay.querySelector('#ov-session').textContent = s.id;
          overlay.querySelector('#ov-course').textContent = s.course;
          overlay.querySelector('#ov-date').textContent = s.date;
          overlay.querySelector('#ov-time').textContent = s.time;
          overlay.querySelector('#ov-status').textContent = s.status;
          const attendeesEl = overlay.querySelector('#ov-attendees');
          attendeesEl.innerHTML = '<li>No attendees recorded.</li>';
          overlay.classList.add('open');
          document.body.style.overflow = 'hidden';
        }

        function closeAttendanceOverlay(){
          const overlay = document.getElementById('attendance-overlay');
          if (!overlay) return;
          overlay.classList.remove('open');
          document.body.style.overflow = '';
        }

        // REPORTS
        const reportFrom = document.getElementById('report-date-from');
        const reportTo = document.getElementById('report-date-to');
        const reportCourse = document.getElementById('report-course');
        const reportGenerateBtn = document.getElementById('report-generate');
        const reportTableBody = document.querySelector('#report-table tbody');
        const reportSummary = document.getElementById('report-summary');
        const downloadPdfBtn = document.getElementById('download-pdf');
        const downloadDocxBtn = document.getElementById('download-docx');

        function renderReportFilters(){
          // ensure courses present in course dropdown
          const keep = new Set(['all']);
          Array.from(reportCourse.options).forEach(o => keep.add(o.value));
          sessionsStore.forEach(s => {
            if (!keep.has(s.course)){
              const opt = document.createElement('option');
              opt.value = s.course; opt.textContent = s.course;
              reportCourse.appendChild(opt);
            }
          });
        }

        function generateReport(){
          loadSessions();
          const from = reportFrom?.value || '';
          const to = reportTo?.value || '';
          const course = reportCourse?.value || 'all';
          const inRange = (d) => {
            if (from && d < from) return false;
            if (to && d > to) return false;
            return true;
          };
          const data = sessionsStore.filter(s =>
            inRange(s.date) && (course==='all' || s.course === course)
          );
          reportTableBody.innerHTML = '';
          let openCount = 0, closedCount = 0;
          data.forEach(s => {
            if (s.status === 'Open') openCount++; else closedCount++;
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${s.id}</td>
              <td>${s.course}</td>
              <td>${s.date}</td>
              <td>${s.time}</td>
              <td><span class="status-badge ${s.status==='Open'?'open':'closed'}">${s.status}</span></td>`;
            reportTableBody.appendChild(tr);
          });
          reportSummary.innerHTML = `
            <div class="details-grid" style="margin: 8px 0 12px;">
              <div><span>Total Sessions</span><strong>${data.length}</strong></div>
              <div><span>Open</span><strong>${openCount}</strong></div>
              <div><span>Closed</span><strong>${closedCount}</strong></div>
            </div>`;
        }

        reportGenerateBtn?.addEventListener('click', generateReport);

        // Exports
        downloadPdfBtn?.addEventListener('click', () => {
          const card = document.getElementById('report-card');
          if (!card) return;
          const opt = {
            margin:       10,
            filename:     `attendance-report-${new Date().toISOString().slice(0,10)}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
          };
          window.html2pdf().from(card).set(opt).save();
        });

        downloadDocxBtn?.addEventListener('click', async () => {
          if (!window.docx) return;
          const { Document, Packer, Paragraph, HeadingLevel, Table, TableRow, TableCell, TextRun, WidthType } = window.docx;
          const rows = [];
          // header
          rows.push(new TableRow({ children: ['Session','Course','Date','Time','Status'].map(t => new TableCell({ children:[new Paragraph({ children:[new TextRun({ text:t, bold:true })] })] })) }));
          // body
          document.querySelectorAll('#report-table tbody tr').forEach(tr => {
            const cells = Array.from(tr.children).map(td => new TableCell({ children:[new Paragraph(String(td.textContent||''))] }));
            rows.push(new TableRow({ children: cells }));
          });
          const table = new Table({ rows, width: { size: 100, type: WidthType.PERCENTAGE } });
          const doc = new Document({
            sections: [{
              children: [
                new Paragraph({ text: 'Attendance Report', heading: HeadingLevel.HEADING_1 }),
                new Paragraph({ text: `Generated: ${new Date().toLocaleString()}` }),
                table
              ]
            }]
          });
          const blob = await Packer.toBlob(doc);
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `attendance-report-${new Date().toISOString().slice(0,10)}.docx`;
          a.click();
          URL.revokeObjectURL(a.href);
        });

        generateQrBtn && generateQrBtn.addEventListener('click', generateNewSession);
        
        // Course selection event listener
        courseSelect && courseSelect.addEventListener('change', (e) => {
          selectedCourse = e.target.value;
          if (selectedCourse) {
            // Clear previous QR code when course changes
            if (qrCodeInstance) {
              qrCodeInstance.clear();
            }
            qrDisplayArea.style.display = 'none';
            courseSessionInfo.style.display = 'none';
            pinDisplay.textContent = '';
            timerDisplay.textContent = '';
            clearExistingTimer();
            
            // Hide the session status indicator and close session buttons
            document.getElementById('session-status-indicator').style.display = 'none';
            document.getElementById('close-session-btn').style.display = 'none';
            document.getElementById('prominent-close-session-btn').style.display = 'none';
          }
        });
        
        // Initialize recent sessions display
        displayRecentSessions();
        
        // Function to close current session manually
        window.closeCurrentSession = function() {
          if (confirm('Are you sure you want to close the current session?')) {
            // Close the session properly
            if (selectedCourse) {
              try {
                const courseSessions = JSON.parse(localStorage.getItem('courseSessions') || '[]');
                const activeSession = courseSessions.find(s => s.status === 'active' && s.courseCode === selectedCourse);
                if (activeSession) {
                  activeSession.status = 'closed';
                  activeSession.closedTime = new Date().toISOString();
                  localStorage.setItem('courseSessions', JSON.stringify(courseSessions));
                }
              } catch (e) {
                console.warn('Failed to update course session status:', e);
              }
            }
            
            // Also update the legacy sessions store
            const openSession = sessionsStore.find(s => s.status === 'Open');
            if (openSession) {
              openSession.status = 'Closed';
              persistSessions();
            }
            
            // Mark QR as expired and clear display
            markQrExpired();
            
            // Hide the session status indicator and close buttons
            document.getElementById('session-status-indicator').style.display = 'none';
            document.getElementById('close-session-btn').style.display = 'none';
            document.getElementById('prominent-close-session-btn').style.display = 'none';
            
            // Refresh displays
            displayRecentSessions();
            if (document.getElementById('attendance')?.style.display === 'block') {
              renderAttendance();
            }
            
            // Show confirmation message
            alert('Session has been closed successfully!');
          }
        };

        // ENHANCED CALENDAR/SCHEDULER
        const monthName = document.getElementById('calendar-month');
        const prevBtn = document.getElementById('calendar-prev');
        const nextBtn = document.getElementById('calendar-next');
        const weekdaysEl = document.getElementById('calendar-weekdays');
        const daysEl = document.getElementById('calendar-days');
        const selectedDateLabel = document.getElementById('selected-date-label');
        const selectedDateDisplay = document.getElementById('selected-date-display');
        const eventsList = document.getElementById('events-list');
        const exportEventsBtn = document.getElementById('export-events-btn');
        
        // Event form elements
        const eventForm = document.getElementById('event-form');
        const eventTitleInput = document.getElementById('event-title');
        const eventTimeInput = document.getElementById('event-time');
        const eventDurationInput = document.getElementById('event-duration');
        const eventTypeInput = document.getElementById('event-type');
        const eventLocationInput = document.getElementById('event-location');
        const eventDescriptionInput = document.getElementById('event-description');
        const eventRecurringInput = document.getElementById('event-recurring');
        const recurringEndContainer = document.getElementById('recurring-end-container');
        const eventRecurringEndInput = document.getElementById('event-recurring-end');
        const clearEventBtn = document.getElementById('clear-event-btn');

        const WEEKDAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        // Enhanced event structure
        class CalendarEvent {
          constructor(data) {
            this.id = data.id || this.generateId();
            this.title = data.title;
            this.time = data.time || '';
            this.duration = data.duration || 60;
            this.type = data.type || 'other';
            this.location = data.location || '';
            this.description = data.description || '';
            this.recurring = data.recurring || 'none';
            this.recurringEnd = data.recurringEnd || null;
            this.createdAt = data.createdAt || new Date().toISOString();
            this.updatedAt = data.updatedAt || new Date().toISOString();
          }

          generateId() {
            return 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          }

          getEndTime() {
            if (!this.time) return null;
            const [hours, minutes] = this.time.split(':').map(Number);
            const startDate = new Date();
            startDate.setHours(hours, minutes, 0, 0);
            return new Date(startDate.getTime() + this.duration * 60000);
          }

          getFormattedTime() {
            if (!this.time) return 'All day';
            const endTime = this.getEndTime();
            if (endTime) {
              return `${this.time} - ${endTime.toTimeString().slice(0, 5)}`;
            }
            return this.time;
          }

          getTypeColor() {
            const colors = {
              lecture: '#3498db',
              tutorial: '#e74c3c',
              lab: '#2ecc71',
              meeting: '#f39c12',
              exam: '#9b59b6',
              other: '#95a5a6'
            };
            return colors[this.type] || colors.other;
          }
        }

        // Calendar state
        let calendarCursor = new Date();
        calendarCursor.setDate(1);
        let selectedDate = null;
        let eventsStore = new Map();

        // Utility functions using date-fns with fallbacks
        function formatDate(date) {
          try {
            if (window.dateFns && window.dateFns.format) {
              return window.dateFns.format(date, 'yyyy-MM-dd');
            }
          } catch (e) {
            console.warn('date-fns format failed, using fallback:', e);
          }
          return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function parseDate(dateStr) {
          try {
            if (window.dateFns && window.dateFns.parseISO) {
              return window.dateFns.parseISO(dateStr);
            }
          } catch (e) {
            console.warn('date-fns parseISO failed, using fallback:', e);
          }
          return new Date(dateStr);
        }

        function addDays(date, days) {
          try {
            if (window.dateFns && window.dateFns.addDays) {
              return window.dateFns.addDays(date, days);
            }
          } catch (e) {
            console.warn('date-fns addDays failed, using fallback:', e);
          }
          return new Date(date.getTime() + days * 24 * 60 * 60 * 1000);
        }

        function addWeeks(date, weeks) {
          try {
            if (window.dateFns && window.dateFns.addWeeks) {
              return window.dateFns.addWeeks(date, weeks);
            }
          } catch (e) {
            console.warn('date-fns addWeeks failed, using fallback:', e);
          }
          return new Date(date.getTime() + weeks * 7 * 24 * 60 * 60 * 1000);
        }

        function addMonths(date, months) {
          try {
            if (window.dateFns && window.dateFns.addMonths) {
              return window.dateFns.addMonths(date, months);
            }
          } catch (e) {
            console.warn('date-fns addMonths failed, using fallback:', e);
          }
          return new Date(date.getTime() + months * 30 * 24 * 60 * 60 * 1000);
        }

        function isSameDay(date1, date2) {
          try {
            if (window.dateFns && window.dateFns.isSameDay) {
              return window.dateFns.isSameDay(date1, date2);
            }
          } catch (e) {
            console.warn('date-fns isSameDay failed, using fallback:', e);
          }
          return date1.toDateString() === date2.toDateString();
        }

        function isToday(date) {
          try {
            if (window.dateFns && window.dateFns.isToday) {
              return window.dateFns.isToday(date);
            }
          } catch (e) {
            console.warn('date-fns isToday failed, using fallback:', e);
          }
          return isSameDay(date, new Date());
        }

        // Storage functions
        function loadEvents() {
          try {
            // Load lecturer's own events
            const stored = localStorage.getItem('lecturerCalendarEvents');
            if (stored) {
              const parsed = JSON.parse(stored);
              eventsStore.clear();
              Object.entries(parsed).forEach(([date, events]) => {
                eventsStore.set(date, events.map(evt => new CalendarEvent(evt)));
              });
            }
            
            // Load admin events that are relevant for lecturers
            try {
              const adminEvents = localStorage.getItem('adminCalendarEvents');
              if (adminEvents) {
                const parsed = JSON.parse(adminEvents);
                Object.entries(parsed).forEach(([date, events]) => {
                  const relevantEvents = events.filter(evt => 
                    evt.isAdminEvent && 
                    (evt.type === 'Lecture' || evt.type === 'Tutorial' || evt.type === 'Exam' || evt.type === 'Meeting')
                  );
                  
                  if (relevantEvents.length > 0) {
                    const existingEvents = eventsStore.get(date) || [];
                    const adminCalendarEvents = relevantEvents.map(evt => new CalendarEvent({
                      id: 'admin_' + evt.id,
                      title: evt.title || '',
                      time: evt.time || '',
                      duration: 60, // Default duration for admin events
                      type: evt.type || 'Other',
                      location: evt.location || '',
                      description: evt.description || '',
                      recurring: 'none',
                      recurringEnd: null,
                      course: evt.course || '',
                      lecturer: evt.lecturer || '',
                      notes: evt.notes || '',
                      isAdminEvent: true,
                      createdBy: 'admin',
                      createdAt: evt.createdAt || new Date().toISOString()
                    }));
                    eventsStore.set(date, [...existingEvents, ...adminCalendarEvents]);
                  }
                });
              }
            } catch (e) {
              console.warn('Failed to load admin events:', e);
            }
          } catch (e) {
            console.error('Failed to load calendar events:', e);
            eventsStore.clear();
          }
        }

        function saveEvents() {
          try {
            const serialized = {};
            eventsStore.forEach((events, date) => {
              serialized[date] = events.map(evt => Object.assign({}, evt));
            });
            localStorage.setItem('lecturerCalendarEvents', JSON.stringify(serialized));
          } catch (e) {
            console.error('Failed to save calendar events:', e);
          }
        }

        function getEventsForDate(date) {
          const dateStr = formatDate(date);
          return eventsStore.get(dateStr) || [];
        }

        function addEventToDate(date, event) {
          const dateStr = formatDate(date);
          if (!eventsStore.has(dateStr)) {
            eventsStore.set(dateStr, []);
          }
          eventsStore.get(dateStr).push(event);
          
          // Handle recurring events
          if (event.recurring !== 'none' && event.recurringEnd) {
            createRecurringEvents(event, date, event.recurringEnd);
          }
          
          saveEvents();
        }

        function createRecurringEvents(event, startDate, endDate) {
          const end = parseDate(endDate);
          let current = new Date(startDate);
          
          while (current <= end) {
            switch (event.recurring) {
              case 'daily':
                current = addDays(current, 1);
                break;
              case 'weekly':
                current = addWeeks(current, 1);
                break;
              case 'biweekly':
                current = addWeeks(current, 2);
                break;
              case 'monthly':
                current = addMonths(current, 1);
                break;
              default:
                return;
            }
            
            if (current <= end) {
              const recurringEvent = new CalendarEvent({
                ...event,
                id: event.id + '_' + formatDate(current),
                recurring: 'none', // Don't recur the recurring events
                recurringEnd: null
              });
              addEventToDate(current, recurringEvent);
            }
          }
        }

        function removeEvent(eventId, date) {
          const dateStr = formatDate(date);
          const events = eventsStore.get(dateStr);
          if (events) {
            const index = events.findIndex(evt => evt.id === eventId);
            if (index > -1) {
              events.splice(index, 1);
              if (events.length === 0) {
                eventsStore.delete(dateStr);
              }
              saveEvents();
              return true;
            }
          }
          return false;
        }

        // Calendar rendering functions
        function renderWeekdays() {
          weekdaysEl.innerHTML = '';
          WEEKDAYS.forEach(w => {
            const div = document.createElement('div');
            div.className = 'weekday';
            div.textContent = w;
            weekdaysEl.appendChild(div);
          });
        }

        function renderDays() {
          daysEl.innerHTML = '';
          const year = calendarCursor.getFullYear();
          const month = calendarCursor.getMonth();
          const firstDayIndex = new Date(year, month, 1).getDay();
          const daysInMonth = new Date(year, month + 1, 0).getDate();
          
          // Leading blanks
          for (let i = 0; i < firstDayIndex; i++) {
            const div = document.createElement('div');
            div.className = 'day prev';
            daysEl.appendChild(div);
          }

          // Actual days
          for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const div = document.createElement('div');
            div.className = 'day';
            div.textContent = String(d);
            
            // Today highlight
            if (isToday(dateObj)) {
              div.classList.add('today');
            }
            
            // Event indicators
            const events = getEventsForDate(dateObj);
            if (events.length > 0) {
              const eventIndicator = document.createElement('div');
              eventIndicator.className = 'event-indicator';
              
              const adminEvents = events.filter(evt => evt.isAdminEvent);
              const regularEvents = events.filter(evt => !evt.isAdminEvent);
              
              eventIndicator.innerHTML = `
                <span class="event-count">${events.length}</span>
                <div class="event-dots">
                  ${events.slice(0, 3).map(evt => 
                    `<span class="event-dot ${evt.isAdminEvent ? 'admin-dot' : ''}" style="background-color: ${evt.getTypeColor()}"></span>`
                  ).join('')}
                  ${events.length > 3 ? `<span class="event-dot-more">+${events.length - 3}</span>` : ''}
                </div>
                ${adminEvents.length > 0 ? `<div class="admin-indicator">A</div>` : ''}
              `;
              div.appendChild(eventIndicator);
            }
            
            div.addEventListener('click', () => {
              selectDate(dateObj);
            });
            
            daysEl.appendChild(div);
          }
        }

        function renderHeader() {
          try {
            if (window.dateFns && window.dateFns.format) {
              monthName.textContent = window.dateFns.format(calendarCursor, 'MMMM yyyy');
              return;
            }
          } catch (e) {
            console.warn('date-fns format failed, using fallback:', e);
          }
          
          const y = calendarCursor.getFullYear();
          const m = calendarCursor.toLocaleString(undefined, { month: 'long' });
          monthName.textContent = `${m} ${y}`;
        }

        function selectDate(date) {
          selectedDate = date;
          const dateStr = formatDate(date);
          selectedDateLabel.textContent = dateStr;
          selectedDateDisplay.textContent = dateStr;
          renderEvents();
          exportEventsBtn.style.display = getEventsForDate(date).length > 0 ? 'inline-block' : 'none';
        }

        function renderEvents() {
          if (!selectedDate) {
            eventsList.innerHTML = '<li class="no-events">Select a date to view events</li>';
            return;
          }

          const events = getEventsForDate(selectedDate);
          eventsList.innerHTML = '';

          if (events.length === 0) {
            eventsList.innerHTML = '<li class="no-events">No events for this date</li>';
            return;
          }

          // Sort events by time
          events.sort((a, b) => {
            if (!a.time && !b.time) return 0;
            if (!a.time) return 1;
            if (!b.time) return -1;
            return a.time.localeCompare(b.time);
          });

          events.forEach(event => {
            const li = document.createElement('li');
            li.className = `event-item ${event.isAdminEvent ? 'admin-event' : ''}`;
            li.innerHTML = `
              <div class="event-header">
                <span class="event-type-badge" style="background-color: ${event.getTypeColor()}">${event.type}</span>
                ${event.isAdminEvent ? '<span class="admin-badge">Admin</span>' : ''}
                <span class="event-time">${event.getFormattedTime()}</span>
                ${!event.isAdminEvent ? `<button class="event-delete-btn" data-event-id="${event.id}" title="Delete event">Ã—</button>` : ''}
              </div>
              <div class="event-title">${event.title}</div>
              ${event.location ? `<div class="event-location"><i class="fas fa-map-marker-alt"></i> ${event.location}</div>` : ''}
              ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
              ${event.course ? `<div class="event-course"><i class="fas fa-book"></i> Course: ${event.course}</div>` : ''}
              ${event.lecturer ? `<div class="event-lecturer"><i class="fas fa-chalkboard-teacher"></i> Lecturer: ${event.lecturer}</div>` : ''}
              ${event.notes ? `<div class="event-notes"><i class="fas fa-sticky-note"></i> ${event.notes}</div>` : ''}
            `;
            eventsList.appendChild(li);
          });

          // Bind delete buttons
          eventsList.querySelectorAll('.event-delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              e.stopPropagation();
              const eventId = btn.getAttribute('data-event-id');
              if (confirm('Are you sure you want to delete this event?')) {
                removeEvent(eventId, selectedDate);
                renderEvents();
                renderDays();
                exportEventsBtn.style.display = getEventsForDate(selectedDate).length > 0 ? 'inline-block' : 'none';
              }
            });
          });
        }

        // Function to refresh admin events
        function refreshAdminEvents() {
          loadEvents();
          if (selectedDate) {
            renderEvents();
            renderDays();
          }
        }

        // Event form handling
        function handleEventSubmit(e) {
          e.preventDefault();
          
          if (!selectedDate) {
            alert('Please select a date on the calendar first.');
            return;
          }

          const title = eventTitleInput.value.trim();
          if (!title) {
            alert('Please enter an event title.');
            return;
          }

          const event = new CalendarEvent({
            title: title,
            time: eventTimeInput.value || '',
            duration: parseInt(eventDurationInput.value) || 60,
            type: eventTypeInput.value,
            location: eventLocationInput.value.trim(),
            description: eventDescriptionInput.value.trim(),
            recurring: eventRecurringInput.value,
            recurringEnd: eventRecurringEndInput.value || null
          });

          addEventToDate(selectedDate, event);
          
          // Clear form
          eventForm.reset();
          eventRecurringEndInput.style.display = 'none';
          
          // Refresh displays
          renderEvents();
          renderDays();
          exportEventsBtn.style.display = 'inline-block';
          
          // Show success message
          showNotification('Event added successfully!', 'success');
        }

        function handleRecurringChange() {
          const isRecurring = eventRecurringInput.value !== 'none';
          recurringEndContainer.style.display = isRecurring ? 'block' : 'none';
          
          if (isRecurring && !eventRecurringEndInput.value) {
            // Set default end date to 3 months from now
            const defaultEnd = new Date();
            defaultEnd.setMonth(defaultEnd.getMonth() + 3);
            eventRecurringEndInput.value = formatDate(defaultEnd);
          }
        }

        function clearEventForm() {
          eventForm.reset();
          recurringEndContainer.style.display = 'none';
        }

        function exportEvents() {
          if (!selectedDate) return;
          
          const events = getEventsForDate(selectedDate);
          if (events.length === 0) return;
          
          const csvContent = [
            ['Date', 'Time', 'Title', 'Type', 'Location', 'Description', 'Duration'],
            ...events.map(evt => [
              formatDate(selectedDate),
              evt.getFormattedTime(),
              evt.title,
              evt.type,
              evt.location || '',
              evt.description || '',
              evt.duration + ' minutes'
            ])
          ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
          
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `events-${formatDate(selectedDate)}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        }

        function showNotification(message, type = 'info') {
          // Simple notification system
          const notification = document.createElement('div');
          notification.className = `notification notification-${type}`;
          notification.textContent = message;
          document.body.appendChild(notification);
          
          setTimeout(() => {
            notification.classList.add('show');
          }, 100);
          
          setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
          }, 3000);
        }

        // Navigation functions
        function goToPreviousMonth() {
          calendarCursor.setMonth(calendarCursor.getMonth() - 1);
          renderHeader();
          renderDays();
        }

        function goToNextMonth() {
          calendarCursor.setMonth(calendarCursor.getMonth() + 1);
          renderHeader();
          renderDays();
        }

        function goToToday() {
          calendarCursor = new Date();
          calendarCursor.setDate(1);
          renderHeader();
          renderDays();
          selectDate(new Date());
        }

        // Event listeners
        eventForm?.addEventListener('submit', handleEventSubmit);
        eventRecurringInput?.addEventListener('change', handleRecurringChange);
        clearEventBtn?.addEventListener('click', clearEventForm);
        exportEventsBtn?.addEventListener('click', exportEvents);
        
        prevBtn?.addEventListener('click', goToPreviousMonth);
        nextBtn?.addEventListener('click', goToNextMonth);
        
        // Add today button to calendar header
        const todayBtn = document.createElement('div');
        todayBtn.className = 'btn today-btn';
        todayBtn.textContent = 'Today';
        todayBtn.addEventListener('click', goToToday);
        document.querySelector('.calendar .btns').appendChild(todayBtn);

        // Initialize calendar
        function initializeCalendar() {
          try {
            loadEvents();
            renderHeader();
            renderWeekdays();
            renderDays();
            selectDate(new Date());
            
            // Show success notification
            showNotification('Calendar loaded successfully!', 'success');
          } catch (error) {
            console.error('Failed to initialize calendar:', error);
            showNotification('Failed to load calendar. Using fallback mode.', 'error');
            
            // Fallback initialization
            try {
              loadEvents();
              renderHeader();
              renderWeekdays();
              renderDays();
              selectDate(new Date());
            } catch (fallbackError) {
              console.error('Fallback calendar initialization failed:', fallbackError);
              showNotification('Calendar initialization failed completely.', 'error');
            }
          }
        }
        
        // Initialize after a short delay to ensure DOM is ready
        setTimeout(initializeCalendar, 100);
        
        // Set up periodic refresh of admin events (every 30 seconds)
        setTimeout(() => {
          setInterval(refreshAdminEvents, 30000);
        }, 5000); // Start after 5 seconds
        
        // Mobile sidebar functionality
        document.getElementById('sidebar-toggle').addEventListener('click', function() {
          const sidebar = document.getElementById('sidebar2');
          sidebar.classList.add('active');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        });
        
        document.getElementById('sidebar-close').addEventListener('click', function() {
          const sidebar = document.getElementById('sidebar2');
          sidebar.classList.remove('active');
          document.body.style.overflow = ''; // Restore scrolling
        });
        
        // Close sidebar when clicking outside
        document.getElementById('sidebar2').addEventListener('click', function(e) {
          if (e.target === this) {
            this.classList.remove('active');
            document.body.style.overflow = '';
          }
        });
        
        // Close sidebar on escape key
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            const sidebar = document.getElementById('sidebar2');
            if (sidebar.classList.contains('active')) {
              sidebar.classList.remove('active');
              document.body.style.overflow = '';
            }
          }
        });
        
        // Handle mobile navigation clicks
        document.querySelectorAll('#sidebar2 .lecturer-nav-item[data-target]').forEach(navItem => {
          navItem.addEventListener('click', (e) => {
            e.preventDefault();
            const target = navItem.getAttribute('data-target');
            
            // Hide all sections
            sections.forEach((sec) => {
              sec.style.display = 'none';
            });
            
            // Show target section
            const targetSection = document.getElementById(target);
            if (targetSection) {
              targetSection.style.display = 'block';
            }
            
            // Update active state in both sidebars
            document.querySelectorAll('.lecturer-nav-item').forEach(item => {
              item.classList.remove('active');
            });
            navItem.classList.add('active');
            
            // Also update the main sidebar
            const mainNavItem = document.querySelector(`.sidebar .lecturer-nav-item[data-target="${target}"]`);
            if (mainNavItem) {
              mainNavItem.classList.add('active');
            }
            
            // Close mobile sidebar
            const sidebar = document.getElementById('sidebar2');
            sidebar.classList.remove('active');
            document.body.style.overflow = '';
          });
        });
        
        // Handle external links in mobile sidebar
        document.querySelectorAll('#sidebar2 .lecturer-nav-item[href]:not([data-target])').forEach(navItem => {
          navItem.addEventListener('click', () => {
            // Close mobile sidebar before navigation
            const sidebar = document.getElementById('sidebar2');
            sidebar.classList.remove('active');
            document.body.style.overflow = '';
          });
        });
        });

      

    </script>
  </body>
</html>